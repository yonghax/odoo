<?xml version="1.0" encoding="utf-8"?>
<odoo>

	<!-- Advances -->
	
	<record id="view_advances_tree" model="ir.ui.view">
	    <field name="name">hr.advance.tree</field>
	    <field name="model">hr.advance</field>
	    <field name="arch" type="xml">
	        <tree string="Expenses" decoration-warning="state=='draft'" decoration-bf="message_unread == True">
	            <field name="date"/>
	            <field name="name"/>
	            <field name="employee_id"/>
	            <field name="amount" sum="Total Amount" widget="monetary"/>
	            <field name="state"/>
	            <field name="message_unread" invisible="1"/>
	            <button name="submit_advances" states="draft" string="Submit to Manager" type="object" icon="fa-check"/>
	            <button name="approve_advances" states="submit" string="Click here to approve" type="object" icon="fa-check" groups="hr_advance.group_approve_expense"/>
                <button name="%(hr_advance.hr_advance_refuse_wizard_action)d" states="submit" string="Click here to refuse" type="action" icon="fa-times" groups="hr_advance.group_approve_expense"/>
	        </tree>
	    </field>
	</record>
	
    <record id="hr_advance_my_tree" model="ir.ui.view">
        <field name="name">my.hr.advance.tree</field>
        <field name="model">hr.advance</field>
        <field name="arch" type="xml">
            <tree string="Advances" decoration-warning="state=='draft'" decoration-bf="message_unread == True">
                <field name="date"/>
                <field name="name"/>
                <field name="amount" sum="Total Amount" widget="monetary"/>
                <field name="state"/>
                <field name="message_unread" invisible="1"/>
                <button name="submit_advances" states="draft" string="Submit to Manager" type="object" icon="fa-check"/>
                <button name="approve_advances" states="submit" string="Click here to approve" type="object" icon="fa-check" groups="hr_advance.group_approve_expense"/>
                <button name="%(hr_advance.hr_advance_refuse_wizard_action)d" states="submit" string="Click here to refuse" type="action" icon="fa-times" groups="hr_advance.group_approve_expense"/>
            </tree>
        </field>
    </record>

    <record id="hr_advance_form_view" model="ir.ui.view">
        <field name="name">hr.advance.form</field>
        <field name="model">hr.advance</field>
        <field eval="25" name="priority"/>
        <field name="arch" type="xml">
            <form string="Advances">
            <header>
                <button name="submit_advances" states="draft" string="Submit to Manager" type="object" class="oe_highlight"/>
                <button name="approve_advances" states="submit" string="Approve" type="object" groups="hr_advance.group_approve_expense" class="oe_highlight"/>
                <button name="%(hr_advance.hr_advance_refuse_wizard_action)d" states="submit" string="Refuse" type="action" groups="hr_advance.group_approve_expense" />
                <button name="%(hr_advance.hr_advance_refuse_wizard_action)d" states="approve" string="Refuse" type="action" groups="account.group_account_user" />
                <button name="reset_advances" states="cancel" string="Set to Draft" type="object"/>
                <button name="action_move_create" states="approve" string="Post Journal Entries" type="object" groups="account.group_account_user" class="oe_highlight"/>
                <field name="state" widget="statusbar" statusbar_visible="draft,submit,approve,post,done" statusbar_colors='{"submit":"blue","cancel":"red"}'/>
            </header>
            <sheet>
                <div class="oe_title">
                    <label for="name"/>
                    <h1>
                        <field name="name" placeholder="e.g. Expense Advance for business trip"/>
                    </h1>
                </div>
                <group>
                    <group>
                        <field name="amount" required="1" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                    </group><group>
                        <field name="date"/>
                        <field name="employee_id"/>
                        <field name="currency_id" groups="base.group_multi_currency"/>
                        <field name="department_id" invisible="1"/>
                        <field name="company_id" groups="base.group_multi_company"/>
                        <field name="payment_date" readonly="1"
                        	attrs="{'invisible': [('state', 'not in', ['post', 'done'])]}"/>
                        <field name="account_move_id" readonly="1"/>
                    </group>

                </group>
                <div>
                    <field name="description" placeholder="Notes..."/>
                </div>
            </sheet>
            <div class="oe_chatter">
                <field name="message_follower_ids" widget="mail_followers"/>
                <field name="message_ids" widget="mail_thread"/>
            </div>
            </form>
        </field>
    </record>

    <record id="hr_advance_account_user_form_view" model="ir.ui.view">
        <field name="name">hr.advance.form.account_user</field>
        <field name="model">hr.advance</field>
        <field name="inherit_id" ref="hr_advance_form_view"/>
        <field name="groups_id" eval="[(6, 0, [ref('account.group_account_user')])]"/>
        <field name="arch" type="xml">
        	<field name="amount" position="after">
                <field name="bank_journal_id" options="{'no_open': True, 'no_create': True}"/>
                <label for="add_bank_statement"/>
                <div>
                    <field name="add_bank_statement"/>
                    <field name="bank_statement_id"
                    	options="{'no_open': True, 'no_create': True}"
                    	attrs="{'invisible': [('add_bank_statement', '=', False)], 'required': [('add_bank_statement', '=', True)]}"/>
                </div>
        	</field>
        </field>
    </record>

    <record id="hr_advance_kanban_view" model="ir.ui.view">
        <field name="name">hr.advance.kanban</field>
        <field name="model">hr.advance</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="name"/>
                <field name="employee_id"/>
                <field name="amount"/>
                <field name="date"/>
                <field name="state"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                            <div class="row">
                                <div class="col-xs-6">
                                    <strong><span><t t-esc="record.name.value"/></span></strong>
                                </div>
                                <div class="col-xs-6">
                                    <strong><span class="pull-right text-right"><t t-esc="record.amount.value"/></span></strong>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-6 text-muted">
                                    <span><t t-esc="record.employee_id.value"/> <t t-esc="record.date.value"/></span>
                                </div>
                                <div class="col-xs-6">
                                    <span t-attf-class="pull-right text-right label #{['draft', 'submit'].indexOf(record.state.raw_value) > -1 ? 'label-default' : ['cancel'].indexOf(record.state.raw_value) > -1 ? 'label-danger' : ['post'].indexOf(record.state.raw_value) > -1 ? 'label-warning' : ['done'].indexOf(record.state.raw_value) > -1 ? 'label-success' : 'label-primary'}"><t t-esc="record.state.value"/></span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="hr_advance_view_pivot" model="ir.ui.view">
        <field name="name">hr.advance.pivot</field>
        <field name="model">hr.advance</field>
        <field name="arch" type="xml">
            <pivot string="Advances Analysis" disable_linking="True">
                <field name="employee_id" type="row"/>
                <field name="date" interval="month" type="col"/>
                <field name="amount" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="hr_advance_view_graph" model="ir.ui.view">
        <field name="name">hr.advance.graph</field>
        <field name="model">hr.advance</field>
        <field name="arch" type="xml">
            <graph string="Advances Analysis">
                <field name="employee_id" type="col"/>
                <field name="date" interval="month" type="row"/>
                <field name="amount" type="measure"/>
            </graph>
        </field>
    </record>

    <record id="view_hr_advance_filter" model="ir.ui.view">
        <field name="name">hr.advance.filter</field>
        <field name="model">hr.advance</field>
        <field name="arch" type="xml">
            <search string="Advance">
                <field name="name" string="Advances"/>
                <field name="date"/>
                <field name="employee_id"/>
                <field name="department_id" string="Department" context="{'invisible_department': False}"/>
                <separator />
                <filter domain="[('state', '=', 'draft')]" string="New" help="New Advance"/>
                <filter domain="[('state', '=', 'submit')]" string="To Approve" name="submitted" help="Submitted Advances"/>
                <filter domain="[('state', '=', 'approve')]" string="To Pay" name="approved" help="Advances to Pay"/>
                <separator />
                <filter string="My Team Advances" domain="['|', ('employee_id.parent_id.user_id', '=', uid),
                	'|', ('employee_id.department_id.manager_id.user_id', '=', uid),
                	('employee_id.department_id.manager_id.parent_id.user_id', '=', uid)]"
                	groups="hr_advance.group_approve_expense" help="Advances of Your Team Member"/>
                <filter string="My Advances" domain="[('employee_id.user_id', '=', uid)]"/>
                <separator />
                <filter string="New Mail" name="message_unread" domain="[('message_unread', '=', True)]"/>
                <group expand="0" string="Group By">
                    <filter string="Employee" domain="[]" context="{'group_by': 'employee_id'}"/>
                    <filter string="Department" domain="[]" context="{'group_by': 'department_id'}" groups="hr.group_multi_departments"/>
                    <filter string="Company" domain="[]" context="{'group_by': 'company_id'}" groups="base.group_multi_company"/>
                    <filter string="Advances Month" domain="[]" context="{'group_by': 'date'}" help="Advances by Month"/>
                </group>
                <separator />
                <filter domain="[('employee_id.active', '=', False)]" string="Former Employees" name="inactive" groups="base.group_hr_user,base.group_hr_manager,hr_advance.group_approve_expense"/>
            </search>
        </field>
    </record>

    <record id="advance_all" model="ir.actions.act_window">
        <field name="name">My Advances</field>
        <field name="res_model">hr.advance</field>
        <field name="view_mode">tree,kanban,form,graph,pivot</field>
        <field name="search_view_id" ref="view_hr_advance_filter"/>
        <field name="domain">[('employee_id.user_id', '=', uid)]</field>
        <field name="help" type="html">
          <p class="oe_view_nocontent_create">
            Click here to create new advances.
          </p><p>
            Once you have created your advance, submit it to your manager who will validate it.
          </p>
        </field>
    </record>

    <record id="hr_advance_tree_action" model="ir.actions.act_window.view">
        <field name="sequence" eval="0"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="hr_advance_my_tree"/>
        <field name="act_window_id" ref="advance_all"/>
    </record>

    <record id="hr_advance_kanban_action" model="ir.actions.act_window.view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="hr_advance_kanban_view"/>
        <field name="act_window_id" ref="advance_all"/>
    </record>

    <record id="hr_advance_form_action" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="hr_advance_form_view"/>
        <field name="act_window_id" ref="advance_all"/>
    </record>

    
    <record id="action_approved_advance" model="ir.actions.act_window">
        <field name="name">Employee Advances</field>
        <field name="res_model">hr.advance</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="view_id" ref="view_advances_tree"/>
        <field name="domain">[]</field>
        <field name="context">{"search_default_approved": 1}</field>
        <field name="help" type="html">
          <p>
            From here the accountant will be able to approve as well as refuse the advances which are verified by the HR Manager.
          </p>
        </field>
    </record>

    <record id="action_request_approve_advance" model="ir.actions.act_window">
        <field name="name">Advances to Approve</field>
        <field name="res_model">hr.advance</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="context">{'search_default_submitted': 1, 'needaction_menu_ref': 'hr_expense_advance.menu_advance_all'}</field>
        <field name="search_view_id" ref="view_hr_advance_filter"/>
        <field name="view_id" ref="view_advances_tree"/>
        <field name="help" type="html">
          <p class="oe_view_nocontent_create">
            Click here to create new advances.
          </p><p>
            Once you have created your advance, submit it to your manager who will validate it.
          </p>
        </field>
    </record>

    <record id="hr_advance_submit_action_server" model="ir.actions.server">
        <field name="name">Submit Advances</field>
        <field name="type">ir.actions.server</field>
        <field name="model_id" ref="model_hr_advance"/>
        <field name="state">code</field>
        <field name="code">
            self.submit_advances(cr, uid, context.get('active_ids', []), context=context)
        </field>
    </record>

    <record id="action_hr_advance_submit" model="ir.values">
        <field name="name">action_hr_advance_submit</field>
        <field name="action_id" ref="hr_advance_submit_action_server" />
        <field name="value" eval="'ir.actions.server,' + str(ref('hr_advance_submit_action_server'))" />
        <field name="key">action</field>
        <field name="model_id" ref="model_hr_advance"/>
        <field name="model">hr.advance</field>
        <field name="key2">client_action_multi</field>
    </record>

    <record id="action_hr_advance_account_entry" model="ir.values">
        <field name="name">action_hr_advance_account_entry</field>
        <field name="action_id" ref="hr_advance_post_wizard_action" />
        <field name="value" eval="'ir.actions.act_window,' + str(ref('hr_advance_post_wizard_action'))" />
        <field name="key">action</field>
        <field name="model_id" ref="model_hr_expense"/>
        <field name="model">hr.advance</field>
        <field name="key2">client_action_multi</field>
    </record>

    <menuitem id="menu_advance_approved" parent="account.menu_finance_payables" 
        action="action_approved_advance" sequence="15"/>
    <menuitem id="menu_hr_expense_all_sub" name="Expenses &amp; Advances" parent="hr_expense.menu_hr_expense_root"/>
    <menuitem id="menu_advance_all" action="advance_all" name="My Advances" parent="menu_hr_expense_all_sub"/>
    <menuitem id="menu_expense_to_approve_sub" name="To Approve" parent="hr_expense.menu_hr_expense_root"/>
    <menuitem id="menu_advance_to_approve" action="action_request_approve_advance" name="Advances To Approve" parent="menu_expense_to_approve_sub" groups="hr_advance.group_approve_expense"/>

    <record id="hr_advance_action_from_department" model="ir.actions.act_window">
        <field name="name">Advances to Approve</field>
        <field name="res_model">hr.advance</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="search_view_id" ref="view_hr_advance_filter"/>
        <field name="context">{
            'search_default_submitted': 1,
            'search_default_department_id': [active_id],
            'default_department_id': active_id}
        </field>
    </record>

    <record id="hr_advance_action" model="ir.actions.act_window">
        <field name="name">Advances Analysis</field>
        <field name="res_model">hr.advance</field>
        <field name="view_type">form</field>
        <field name="view_mode">pivot,graph,tree,form,kanban</field>
    </record>

    <menuitem id="menu_hr_expense_sub" name="Reporting" sequence="99" parent="hr_expense.menu_hr_expense_root"/>
    <menuitem id="menu_hr_advance" name="Advances" parent="menu_hr_expense_sub" action="hr_advance_action"/>

    <record id="action_hr_advance_report_filtered" model="ir.actions.act_window">
        <field name="name">Advances Analysis</field>
        <field name="res_model">hr.advance</field>
        <field name="view_type">form</field>
        <field name="view_mode">pivot,graph</field>
        <field name="context">{
            'search_default_department_id': [active_id],
            'default_department_id': active_id}
        </field>
    </record>

</odoo>
